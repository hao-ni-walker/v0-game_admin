# 动态路由

<cite>
**本文档引用的文件**
- [route.ts](file://src/app/api/tickets/[id]/route.ts)
- [page.tsx](file://src/app/dashboard/tickets/[id]/page.tsx)
- [ticket.ts](file://src/service/api/ticket.ts)
- [models.ts](file://src/repository/models.ts)
- [jsonRepos.ts](file://src/repository/impl/jsonRepos.ts)
</cite>

## 目录
1. [引言](#引言)
2. [动态路由实现机制](#动态路由实现机制)
3. [参数传递流程](#参数传递流程)
4. [useParams Hook 使用差异](#useparams-hook-使用差异)
5. [参数处理与验证](#参数处理与验证)
6. [错误边界处理](#错误边界处理)
7. [总结](#总结)

## 引言
v0-game_admin系统采用Next.js框架的动态路由功能，实现了工单详情、用户编辑等场景下的RESTful风格页面导航。通过[id]动态路由参数，系统能够根据不同的ID值渲染对应的工单详情页面，提供灵活的内容展示能力。

## 动态路由实现机制
系统在`src/app/api/tickets/[id]`路径下实现了基于ID的动态路由，支持GET、PATCH和DELETE三种HTTP方法。当客户端请求`/api/tickets/123`时，Next.js会自动将`123`作为`params.id`参数传递给路由处理函数。

在API路由中，系统首先对ID参数进行类型转换和有效性验证：
```typescript
const id = parseInt(params.id);
if (isNaN(id)) {
  return errorResponse('无效的工单ID');
}
```
这种设计确保了只有有效的数字ID才能继续后续处理，防止了潜在的安全风险和数据查询错误。

## 参数传递流程
从API路由到页面组件的参数传递流程如下：

1. **API层**：`src/app/api/tickets/[id]/route.ts`接收动态参数`id`，通过`getRepositories()`获取数据访问层实例，调用`repos.tickets.getById(id)`查询工单数据。

2. **服务层**：`TicketAPI`类的`getTicket`方法封装了API请求逻辑，使用`apiRequest(/tickets/${id})`格式化URL路径。

3. **组件层**：`src/app/dashboard/tickets/[id]/page.tsx`作为客户端组件，通过`useParams()` Hook获取路由参数，并在`useEffect`中调用`TicketAPI.getTicket()`获取数据。

```mermaid
flowchart TD
A[客户端请求 /dashboard/tickets/123] --> B[Next.js 路由系统]
B --> C{解析动态参数}
C --> D[id = "123"]
D --> E[渲染 page.tsx 组件]
E --> F[useParams() 获取 id]
F --> G[TicketAPI.getTicket(123)]
G --> H[API route.ts 处理请求]
H --> I[jsonRepos 查询数据]
I --> J[返回工单详情]
J --> K[页面渲染]
```

**Diagram sources**
- [route.ts](file://src/app/api/tickets/[id]/route.ts#L6-L28)
- [page.tsx](file://src/app/dashboard/tickets/[id]/page.tsx#L33-L62)
- [ticket.ts](file://src/service/api/ticket.ts#L62-L64)

**Section sources**
- [route.ts](file://src/app/api/tickets/[id]/route.ts#L6-L112)
- [page.tsx](file://src/app/dashboard/tickets/[id]/page.tsx#L1-L242)

## useParams Hook 使用差异
在服务端和客户端组件中，`useParams` Hook的使用存在显著差异：

### 服务端组件
服务端组件无法直接使用`useParams`，需要通过页面函数的参数接收：
```typescript
export default async function Page({ params }: { params: { id: string } }) {
  const ticket = await getTicketById(parseInt(params.id));
  // 直接在服务端渲染
}
```

### 客户端组件
客户端组件通过导入Hook使用：
```typescript
'use client';
import { useParams } from 'next/navigation';

export default function TicketDetailPage() {
  const params = useParams();
  // 在客户端交互中使用
}
```

关键差异体现在：
- **执行时机**：服务端参数在服务器渲染时解析，客户端参数在浏览器中解析
- **数据获取**：服务端可直接查询数据库，客户端需通过API请求
- **SEO影响**：服务端渲染有利于SEO，客户端渲染提供更好的交互体验

**Section sources**
- [page.tsx](file://src/app/dashboard/tickets/[id]/page.tsx#L4-L32)

## 参数处理与验证
系统实现了多层次的参数处理和验证机制：

### 类型安全
通过TypeScript接口定义确保类型安全：
```typescript
interface Ticket {
  id: number;
  title: string;
  status: 'open' | 'in_progress' | 'pending' | 'resolved' | 'closed' | 'canceled';
}
```

### 输入验证
在API路由中进行严格的输入验证：
```typescript
if (isNaN(id)) {
  return errorResponse('无效的工单ID');
}
```

### 数据验证
数据访问层验证数据存在性：
```typescript
const ticket = await repos.tickets.getById(id);
if (!ticket) {
  return errorResponse('工单不存在', 404);
}
```

### 安全处理
- 使用`parseInt`转换字符串参数为数字
- 对无效ID返回明确的错误信息
- 在客户端处理异常情况，避免页面崩溃

**Section sources**
- [route.ts](file://src/app/api/tickets/[id]/route.ts#L12-L22)
- [jsonRepos.ts](file://src/repository/impl/jsonRepos.ts#L666-L674)

## 错误边界处理
系统实现了完善的错误边界处理机制：

### 客户端错误处理
在页面组件中使用try-catch捕获异步操作错误：
```typescript
try {
  const response = await TicketAPI.getTicket(Number(params.id));
  if (response.success && response.data) {
    setTicket(response.data);
  } else {
    toast.error('获取工单详情失败');
    router.push('/dashboard/tickets');
  }
} catch (error) {
  console.error('获取工单详情失败:', error);
  toast.error('获取工单详情失败');
  router.push('/dashboard/tickets');
} finally {
  setLoading(false);
}
```

### 服务端错误处理
API路由中包含全面的异常捕获：
```typescript
try {
  // 业务逻辑
} catch (error) {
  console.error('获取工单详情失败:', error);
  return errorResponse('获取工单详情失败');
}
```

### 用户体验优化
- 显示加载状态（Loader2组件）
- 提供友好的错误提示（toast通知）
- 自动重定向到安全页面
- 记录错误日志供调试

**Section sources**
- [page.tsx](file://src/app/dashboard/tickets/[id]/page.tsx#L42-L56)
- [route.ts](file://src/app/api/tickets/[id]/route.ts#L25-L28)

## 总结
v0-game_admin系统的动态路由实现体现了现代Web应用开发的最佳实践。通过合理的架构设计，系统实现了：
- RESTful风格的URL设计
- 类型安全的参数处理
- 完善的错误处理机制
- 服务端与客户端的协同工作

开发者在实现类似功能时，应遵循以下原则：
1. 始终验证动态参数的有效性
2. 区分服务端和客户端的参数处理方式
3. 实现多层次的错误边界
4. 提供良好的用户体验反馈
5. 保持代码的类型安全和可维护性