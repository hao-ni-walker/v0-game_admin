# 部署指南

<cite>
**本文档引用的文件**  
- [DEPLOYMENT.md](file://DEPLOYMENT.md)
- [.env.example](file://.env.example)
- [package.json](file://package.json)
- [scripts/init-admin.ts](file://scripts/init-admin.ts)
- [src/config/surper-admin.ts](file://src/config/surper-admin.ts)
- [next.config.ts](file://next.config.ts)
- [src/repository/impl/jsonRepos.ts](file://src/repository/impl/jsonRepos.ts)
- [src/repository/store/jsonStore.ts](file://src/repository/store/jsonStore.ts)
- [src/repository/models.ts](file://src/repository/models.ts)
- [src/repository/interfaces.ts](file://src/repository/interfaces.ts)
- [src/repository/index.ts](file://src/repository/index.ts)
</cite>

## 目录
1. [生产部署方案](#生产部署方案)
2. [环境变量配置](#环境变量配置)
3. [部署最佳实践](#部署最佳实践)
4. [常见问题排查](#常见问题排查)
5. [技术支持](#技术支持)

## 生产部署方案

本项目为基于 Next.js 的管理后台系统，支持多种生产环境部署方式。以下为详细部署流程。

### 1. Vercel 部署（推荐）

Vercel 是部署 Next.js 应用的首选平台，提供无缝集成和自动部署能力。

#### 自动部署流程
1. 将 GitHub 仓库连接至 Vercel 项目
2. 在 Vercel 控制台中配置必要的环境变量（详见“环境变量配置”章节）
3. 推送代码至主分支，Vercel 将自动触发构建与部署流程

#### 手动部署命令
```bash
# 安装 Vercel CLI 工具
npm i -g vercel

# 登录账户并部署应用
vercel
```

**Section sources**
- [DEPLOYMENT.md](file://DEPLOYMENT.md#L34-L50)

### 2. Docker 部署

通过 Docker 容器化方式部署，确保环境一致性。

```bash
# 构建应用镜像
docker build -t v0-game_admin .

# 运行容器并传递环境变量
docker run -p 3000:3000 \
  -e DATABASE_URL="your_database_url" \
  -e JWT_SECRET="your_jwt_secret" \
  v0-game_admin
```

> **注意**：由于项目根目录未提供 `Dockerfile`，需根据项目结构自行创建。建议基于 `node:18-alpine` 基础镜像，复制源码、安装依赖并构建生产版本。

**Section sources**
- [DEPLOYMENT.md](file://DEPLOYMENT.md#L52-L60)
- [package.json](file://package.json#L6-L8)

### 3. 传统服务器部署

适用于自有服务器或云主机部署场景。

```bash
# 1. 构建生产版本
pnpm build

# 2. 启动生产服务器（端口 3001）
pnpm start
```

构建过程将生成优化后的静态资源与服务端代码，`start` 命令启动 Next.js 生产服务器。

**Section sources**
- [DEPLOYMENT.md](file://DEPLOYMENT.md#L62-L69)
- [package.json](file://package.json#L7-L8)

## 环境变量配置

部署前需创建 `.env.local` 文件并配置以下环境变量。

### 必需环境变量

| 变量名 | 说明 | 示例值 |
|-------|------|--------|
| `DATABASE_URL` | PostgreSQL 数据库连接字符串 | `postgresql://user:pass@localhost:5432/game_admin` |
| `JWT_SECRET` | JWT 认证密钥，用于生成访问令牌 | `your_strong_random_secret_key` |
| `JWT_REFRESH_SECRET` | JWT 刷新令牌密钥 | `your_refresh_secret_key` |

### 应用配置变量

| 变量名 | 说明 | 示例值 |
|-------|------|--------|
| `NEXT_PUBLIC_APP_NAME` | 应用名称（前端显示） | `"游戏管理后台"` |
| `NEXT_PUBLIC_APP_URL` | 应用公网访问地址 | `https://admin.game.com` |

### 管理员账户配置（可选）

| 变量名 | 说明 | 默认值 |
|-------|------|--------|
| `ADMIN_EMAIL` | 超级管理员邮箱 | `admin@example.com` |
| `ADMIN_USERNAME` | 超级管理员用户名 | `Administrator` |
| `ADMIN_PASSWORD` | 超级管理员密码 | `Admin@123456` |
| `SALT_ROUNDS` | 密码哈希强度 | `12` |

> **提示**：初始化管理员账户可通过 `pnpm init:admin` 脚本自动完成，脚本读取上述环境变量进行创建。

**Section sources**
- [DEPLOYMENT.md](file://DEPLOYMENT.md#L72-L94)
- [.env.example](file://.env.example)
- [scripts/init-admin.ts](file://scripts/init-admin.ts)
- [src/config/surper-admin.ts](file://src/config/surper-admin.ts)

## 部署最佳实践

### 1. 性能优化

- **启用 Gzip 压缩**：Next.js 默认支持，确保反向代理（如 Nginx）也启用压缩
- **配置 CDN**：将静态资源（`/_next/static`）托管至 CDN，提升全球访问速度
- **图片优化**：使用 WebP 格式，限制最大尺寸，利用 `next/image` 组件
- **缓存策略**：
  - 静态资源设置长期缓存（`Cache-Control: public, max-age=31536000`）
  - API 响应根据业务需求设置合理缓存时间

### 2. 安全配置

- **HTTPS 强制启用**：所有生产环境必须通过 HTTPS 访问
- **CORS 策略**：在 `next.config.ts` 中配置严格的跨域策略
  ```ts
  // 示例：限制仅允许特定域名
  async headers() {
    return [
      {
        source: '/api/:path*',
        headers: [
          { key: 'Access-Control-Allow-Origin', value: 'https://yourdomain.com' }
        ]
      }
    ]
  }
  ```
- **JWT 安全**：
  - 使用高强度随机密钥（至少 32 字符）
  - 设置合理的过期时间（如 access token 15 分钟，refresh token 7 天）
- **依赖更新**：定期运行 `pnpm audit` 检查安全漏洞，及时升级依赖

### 3. 监控与日志

- **错误监控**：集成 Sentry 或类似工具，捕获前端与服务端异常
- **性能监控**：使用 Prometheus + Grafana 或 Vercel Analytics 监控响应时间
- **日志收集**：
  - 本地部署：将日志输出至文件并使用 Filebeat 收集
  - 云部署：利用平台日志服务（如 AWS CloudWatch、Vercel Logs）
- **数据库监控**：监控连接数、查询性能与慢查询

**Section sources**
- [DEPLOYMENT.md](file://DEPLOYMENT.md#L140-L161)
- [next.config.ts](file://next.config.ts)

## 常见问题排查

### 1. 数据库连接失败

**可能原因与解决方案**：
- **DATABASE_URL 配置错误**：检查用户名、密码、主机、端口、数据库名是否正确
- **数据库服务未运行**：确认 PostgreSQL 服务已启动且可远程访问
- **网络防火墙限制**：检查服务器安全组或防火墙是否开放 5432 端口
- **权限不足**：确认数据库用户拥有对应数据库的全部权限

可通过以下命令测试连接：
```bash
psql "your_database_url"
```

**Section sources**
- [DEPLOYMENT.md](file://DEPLOYMENT.md#L164-L168)

### 2. JWT 认证问题

**常见问题**：
- **JWT_SECRET 未设置**：确保环境变量已正确配置
- **Token 过期**：检查 `exp` 字段，前端应实现刷新机制
- **Token 格式错误**：确保请求头为 `Authorization: Bearer <token>`
- **密钥不匹配**：重启服务后密钥变更导致旧 Token 失效

**调试建议**：
- 使用 `jwt.io` 解码 Token 验证内容
- 检查 `lib/auth.ts` 中的认证逻辑

**Section sources**
- [DEPLOYMENT.md](file://DEPLOYMENT.md#L170-L174)

### 3. 构建失败

**解决方案**：
- **Node.js 版本不兼容**：确保使用 Node.js 18.x 或更高版本
- **依赖冲突**：清理并重新安装依赖
  ```bash
  rm -rf node_modules .pnpm-store
  pnpm install
  ```
- **环境变量缺失**：某些构建步骤可能依赖环境变量，确保 `.env.local` 已配置
- **磁盘空间不足**：检查服务器磁盘使用情况

**Section sources**
- [DEPLOYMENT.md](file://DEPLOYMENT.md#L176-L180)

## 技术支持

若在部署过程中遇到问题，请按以下步骤排查：
1. 检查控制台与服务日志输出
2. 验证所有环境变量配置正确
3. 确认数据库服务可访问
4. 查阅本部署指南与 `DEPLOYMENT.md` 文件
5. 联系开发团队获取技术支持

**Section sources**
- [DEPLOYMENT.md](file://DEPLOYMENT.md#L182-L189)