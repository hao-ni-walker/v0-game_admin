# 常见问题排查

<cite>
**Referenced Files in This Document**   
- [DEPLOYMENT.md](file://DEPLOYMENT.md)
- [next.config.ts](file://next.config.ts)
- [auth.ts](file://src/lib/auth.ts)
- [login/route.ts](file://src/app/api/auth/login/route.ts)
- [logout/route.ts](file://src/app/api/auth/logout/route.ts)
</cite>

## 目录
1. [数据库连接失败排查](#数据库连接失败排查)
2. [JWT认证问题排查](#jwt认证问题排查)
3. [构建失败排查](#构建失败排查)
4. [next.config.ts配置相关问题](#next.config.ts配置相关问题)
5. [系统化故障排查流程](#系统化故障排查流程)

## 数据库连接失败排查

当应用无法连接到数据库时，需从网络、配置和数据库服务三个层面进行系统性检查。

### 网络连通性检查
首先确认应用服务器与数据库服务器之间的网络是否通畅。使用`ping`命令测试数据库主机的可达性，使用`telnet`或`nc`命令测试数据库端口（默认5432）是否开放。若部署在云环境，需检查安全组或防火墙规则是否允许相应端口的入站连接。

### DATABASE_URL格式验证
检查`.env.local`文件中的`DATABASE_URL`环境变量格式是否正确。正确的格式应为：
```
postgresql://username:password@hostname:port/database_name
```
确保用户名、密码、主机地址、端口和数据库名称均正确无误，且特殊字符已进行URL编码。该配置在部署过程中至关重要，但代码库中未直接引用此变量，而是由Prisma等ORM框架在运行时读取。

**Section sources**
- [DEPLOYMENT.md](file://DEPLOYMENT.md#L78)

## JWT认证问题排查

JWT认证问题通常涉及密钥配置、token生命周期和认证中间件三个方面。

### 密钥配置验证
确保`.env.local`文件中正确设置了`JWT_SECRET`环境变量。该密钥用于签发和验证JWT token，必须与登录和认证逻辑中使用的密钥一致。在代码实现中，当环境变量未设置时，会使用默认的`'secret'`作为密钥，但这仅适用于开发环境，生产环境必须配置强密钥。

```mermaid
sequenceDiagram
participant Client as 客户端
participant LoginAPI as 登录API
participant AuthLib as 认证库
participant Logger as 日志服务
Client->>LoginAPI : 提交邮箱和密码
LoginAPI->>AuthLib : 调用JWT签发
AuthLib->>AuthLib : 使用JWT_SECRET签发token
AuthLib->>LoginAPI : 返回包含token的响应
LoginAPI->>Logger : 记录登录成功日志
LoginAPI->>Client : 设置token cookie并返回成功
```

**Diagram sources**
- [login/route.ts](file://src/app/api/auth/login/route.ts#L34-L45)
- [auth.ts](file://src/lib/auth.ts#L28-L31)

### Token生命周期检查
JWT token具有有效期（代码中设置为24小时）。检查token是否已过期，过期的token将无法通过验证。可通过解析token的payload查看`exp`（过期时间）字段。在登出操作中，服务端不维护token黑名单，而是依赖客户端清除cookie来实现登出。

```mermaid
sequenceDiagram
participant Client as 客户端
participant LogoutAPI as 登出API
participant AuthLib as 认证库
participant Logger as 日志服务
Client->>LogoutAPI : 发送登出请求
LogoutAPI->>AuthLib : 尝试解析token获取用户信息
AuthLib-->>LogoutAPI : 返回用户信息或null
LogoutAPI->>Logger : 记录登出日志包含用户信息
LogoutAPI->>Client : 返回成功响应不操作token
```

**Diagram sources**
- [logout/route.ts](file://src/app/api/auth/logout/route.ts#L8-L31)
- [auth.ts](file://src/lib/auth.ts#L67-L76)

### 认证中间件调试
认证逻辑主要在`src/lib/auth.ts`中的`auth()`和`getCurrentUser()`函数实现。`auth()`函数从cookie中读取token并验证，用于服务端组件；`getCurrentUser()`函数从请求头中提取token，用于API路由。调试时可检查请求是否携带正确的`token` cookie，以及服务端是否能正确解析。

**Section sources**
- [auth.ts](file://src/lib/auth.ts#L19-L77)
- [login/route.ts](file://src/app/api/auth/login/route.ts#L69-L74)
- [DEPLOYMENT.md](file://DEPLOYMENT.md#L81)

## 构建失败排查

构建失败可能由Node.js版本、依赖安装或环境变量等问题引起。

### Node.js版本兼容性
检查Node.js版本是否符合要求。根据部署文档，需要Node.js 18.x或更高版本。使用`node --version`命令确认版本。版本不兼容可能导致依赖安装失败或构建过程中出现语法错误。

### 依赖安装异常
清理并重新安装依赖。删除`node_modules`目录和`pnpm-lock.yaml`文件，然后重新运行`pnpm install`。有时依赖包损坏或版本冲突会导致构建失败。此外，确保使用`pnpm`而非其他包管理器，以保持依赖一致性。

### 环境变量缺失
构建过程可能依赖某些环境变量。确保`.env.local`文件存在且包含必要的配置。虽然部分环境变量在运行时才需要，但某些构建时配置可能依赖环境变量。

**Section sources**
- [DEPLOYMENT.md](file://DEPLOYMENT.md#L9-L10)
- [DEPLOYMENT.md](file://DEPLOYMENT.md#L179-L180)

## next.config.ts配置相关问题

`next.config.ts`文件中的配置错误可能引发静态资源访问、图片加载等问题。

### 图片远程域名配置
`next.config.ts`中的`images.remotePatterns`配置了允许加载的远程图片域名。若应用需要加载未在此列表中的域名图片，将导致图片无法显示。当前配置允许`placehold.co`、`cdn.example.com`、`cdn.xreddeercasino.com`以及所有`amazonaws.com`子域名。添加新的图片CDN时，必须在此配置中添加相应的`remotePatterns`。

```mermaid
flowchart TD
A[应用启动] --> B{请求图片资源}
B --> C[图片URL是否匹配remotePatterns?]
C --> |是| D[允许加载]
C --> |否| E[阻止加载并报错]
D --> F[图片正常显示]
E --> G[图片加载失败]
```

**Diagram sources**
- [next.config.ts](file://next.config.ts#L10-L26)

### React严格模式配置
`reactStrictMode`配置根据环境自动切换。开发环境下为`false`，生产环境下为`true`。此配置影响React的双重渲染行为，可能导致某些副作用在开发环境表现正常，但在生产环境出现问题。排查此类问题时，需注意环境差异。

**Section sources**
- [next.config.ts](file://next.config.ts#L4)

## 系统化故障排查流程

建立标准化的故障排查流程，提高问题解决效率。

```mermaid
flowchart TD
A[问题发生] --> B{检查控制台错误}
B --> |有错误| C[分析错误信息]
B --> |无错误| D{查看应用日志}
D --> E[定位问题模块]
C --> E
E --> F{环境变量配置正确?}
F --> |否| G[修正环境变量]
F --> |是| H{网络连接正常?}
H --> |否| I[检查网络配置]
H --> |是| J{代码逻辑问题?}
J --> |是| K[调试相关代码]
J --> |否| L[联系技术支持]
G --> M[重新部署]
I --> M
K --> M
M --> N[验证问题解决]
N --> O{问题解决?}
O --> |是| P[完成]
O --> |否| Q[收集更多信息]
Q --> E
```

**Diagram sources**
- [DEPLOYMENT.md](file://DEPLOYMENT.md#L186-L189)

**Section sources**
- [DEPLOYMENT.md](file://DEPLOYMENT.md#L182-L190)