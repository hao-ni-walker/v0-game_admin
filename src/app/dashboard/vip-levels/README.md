# VIP 等级管理功能说明

## 功能概述

VIP 等级管理模块用于配置和管理用户 VIP 等级体系，包括升级条件、奖励机制、提现限额和会员权益。

## 目录结构

```
src/app/dashboard/vip-levels/
├── components/              # UI 组件
│   ├── VipLevelPageHeader.tsx    # 页面头部
│   ├── VipLevelFilters.tsx       # 筛选器组件
│   ├── VipLevelTable.tsx         # 表格组件
│   └── index.ts                  # 组件导出
├── hooks/                   # 自定义 Hooks
│   ├── useVipLevelFilters.ts     # 筛选器 Hook
│   ├── useVipLevelManagement.ts  # 数据管理 Hook
│   └── index.ts                  # Hooks 导出
├── types.ts                 # TypeScript 类型定义
├── constants.ts             # 常量配置
└── page.tsx                 # 主页面

src/app/api/vip-levels/
├── list/
│   └── route.ts            # 列表接口
└── [id]/
    └── route.ts            # 详情/更新/删除接口

src/docs/
└── vip-levels-api.md       # API 接口文档
```

## 功能特性

### 1. 列表管理

- ✅ 支持分页展示（默认每页 20 条，可选 20/50/100）
- ✅ 多维度筛选：等级范围、经验范围、禁用状态、删除状态
- ✅ 关键词搜索（按等级名称）
- ✅ 多字段排序（等级、经验、奖励、佣金比例、更新时间等）
- ✅ URL 参数同步，支持页面状态分享和刷新保持

### 2. 数据展示

列表字段：
- **基础信息**：ID、等级、等级名称
- **升级条件**：所需经验值
- **奖励配置**：升级奖励、每日奖励
- **提现限额**：每日提现次数上限、每日提现金额上限
- **佣金配置**：佣金比例（百分比显示）
- **系统字段**：版本号、更新时间、禁用状态

### 3. 操作功能

- **查看详情**：查看 VIP 等级的完整信息和权益配置
- **编辑**：修改等级配置（带版本号乐观锁）
- **禁用/启用**：紧急控制等级的可用性
- **删除**：逻辑删除等级（需二次确认）

### 4. 数据校验

- ✅ 等级数值唯一性校验
- ✅ 所需经验值严格递增校验
- ✅ 乐观锁版本控制，防止并发修改冲突

### 5. 权益管理

支持灵活配置的 JSON 权益数据，包括但不限于：
- 客服优先级
- 专属徽章
- 抽奖次数加成
- 任务奖励倍数
- 专属游戏访问
- VIP 专属经理
- 月度礼包
- 生日奖金

## 技术特点

### 前端架构

- **框架**：Next.js 14 (App Router)
- **状态管理**：React Hooks（useVipLevelFilters、useVipLevelManagement）
- **UI 组件**：Shadcn/UI + Tailwind CSS
- **类型安全**：完整的 TypeScript 类型定义

### 数据流

1. **URL 参数** ↔️ **筛选器状态**（双向同步）
2. **筛选器变化** → **API 请求** → **数据更新**
3. **用户操作** → **API 调用** → **刷新列表**

### 代码组织

- **职责分离**：UI 组件、业务逻辑、数据获取分离
- **可复用性**：Hooks 和组件可独立使用
- **可维护性**：清晰的文件结构和命名规范

## 使用方法

### 访问页面

导航至：**游戏运营 > VIP 等级管理**

或直接访问：`/dashboard/vip-levels`

### 筛选和搜索

1. **关键词搜索**：在搜索框输入等级名称
2. **等级范围**：设置最小/最大等级筛选
3. **经验范围**：设置最小/最大经验值筛选
4. **排序**：选择排序字段和方向
5. **显示选项**：
   - 显示禁用：查看已禁用的等级
   - 显示已删除：查看已删除的等级

### 操作流程

#### 创建 VIP 等级

1. 点击"创建等级"按钮
2. 填写等级信息：
   - 等级数值（必须唯一）
   - 等级名称
   - 所需经验值（必须大于前一等级）
   - 升级奖励（可选）
   - 每日奖励（可选）
   - 提现限额（可选，null 使用系统默认）
   - 佣金比例
   - 权益配置（JSON）
3. 提交保存

#### 编辑 VIP 等级

1. 点击列表中的"编辑"按钮
2. 修改需要变更的字段
3. 系统自动带上版本号进行乐观锁校验
4. 提交保存

#### 禁用/启用等级

- 点击"禁用"：紧急下线该等级的权益发放或展示
- 点击"启用"：恢复等级的正常使用

#### 删除等级

1. 点击"删除"按钮
2. 确认删除操作
3. 执行逻辑删除（不影响历史数据回溯）

## API 接口

详细的 API 接口文档请参阅：[VIP 等级管理接口文档](../../docs/vip-levels-api.md)

### 主要接口

- `POST /api/vip-levels/list` - 获取 VIP 等级列表
- `GET /api/vip-levels/{id}` - 获取单个等级详情
- `POST /api/vip-levels` - 创建 VIP 等级
- `PUT /api/vip-levels/{id}` - 更新 VIP 等级
- `DELETE /api/vip-levels/{id}` - 删除 VIP 等级

## 业务规则

### 升级判定

当用户累计经验 ≥ 某等级 `required_exp` 且大于上一等级阈值时升级。

### 奖励发放

- **升级奖励**：首次达到该等级时发放一次
- **每日奖励**：每自然日可领一次，需配合用户等级变更控制

### 提现限额

- VIP 配置的限额优先于系统默认值
- 用户等级变更时自动刷新提现限额

### 佣金计算

- 按配置的 `commission_rate` 计算代理佣金
- 支持在 `benefits` 中配置更复杂的佣金规则

## 注意事项

⚠️ **重要提醒**：

1. **等级阶梯**：`level` 和 `required_exp` 必须严格递增，不允许跳级或倒退
2. **版本控制**：更新操作必须携带正确的版本号
3. **影响评估**：修改等级配置前需评估对现有用户的影响
4. **审计记录**：所有重大变更都应记录操作日志和变更原因
5. **数据精度**：金额字段保留两位小数，比例字段保留四位小数

## 后续开发

待实现功能：

- [ ] 创建/编辑对话框
- [ ] 查看详情对话框
- [ ] 权益编辑器（JSON 可视化编辑）
- [ ] 发放预览功能（预览用户升级后的奖励）
- [ ] 批量导入/导出
- [ ] 等级复制功能
- [ ] 操作日志集成

## 联动模块

本模块与以下模块存在联动关系：

- **玩家管理**：用户等级、经验值显示
- **活动管理**：经验值获取规则
- **奖励系统**：升级奖励、每日奖励发放
- **提现管理**：提现限额控制
- **代理系统**：佣金比例计算
- **审计日志**：操作记录和变更追踪

## 技术支持

如有问题或建议，请参考：

- [项目文档](../../README.md)
- [API 接口文档](../../docs/vip-levels-api.md)
- [系统配置说明](../../docs/system-config.md)
